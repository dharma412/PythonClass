*** Settings ***
Resource        regression.txt
Resource        sma/reports_keywords.txt
Library         BuiltIn
Library         OperatingSystem
Suite Setup     Custom Suite Setup
#Variables         %{SARF_HOME}/variables/sma/constants.py
Suite Teardown  DefaultRegressionSuiteTeardown

*** Variables ***
${amp_search_sha}   //*[@id='amp_search_sha']
${analysis_request}  //*[@id='MAIL_AMP_FILE_ANALYSIS_BY_FILENAME__SUBMIT_TIMESTAMP']
${Listeners_names}  Test_Listeners
${Listeners_type}  public
${Listeners_port}  25
${Listeners_interface}  Management
${Listeners_bounce_profile}  Default
${RAT_action}  Accept
${Mail_incoming}  Incoming
${security_email_name}  ESA_SMA
${CLEAN_MBOX}  %{SARF_HOME}/tests/testdata/esa/advancedmalware/malware.tar.mbox
${CLEAN_MBOX_1}   %{SARF_HOME}/tests/testdata/esa/advancedmalware/amp_clean_exe.mbox
${Incoming_Detect}  1
${Rec_Contains}  Contains
${sha_value_malicious}  9686e0aa321d5dbc011e50db2bb8568c5c252ec0088ac9b02fab1eca795afb26
${sha_value_clean}    42adce4274cdf037a63f8f816a1fad188ce640eb20b20574dddf9abee0e9a72d
${user_operator}    operator1
${user_operator_fullname}   operator1
${user_Read_only_operator}  readonly1
${user_read_only_operator_fullname}   readonly1
${user_guest}    guest1
${user_guest_fullname}   guest1
${user_help_desk}      helpdesk1
${user_help_desk_fullname}   helpdesk1
${user_Technician_operator}  technician1
${user_Technician_fullname}  technician1
${pending_table_export}  //*[@id='ss_0_2_0-links']/span[contains(text(),'Export...')]
${complete_table_export}  //*[@id='ss_1_1_0-links']/span[contains(text(),'Columns...')]
${complete_button}   //button[contains(text(), 'Done')]
${search_button}   //input[@value='Search']


*** Keywords ***
Custom Suite Setup
     DefaultRegressionSuiteSetup
     Run Keyword If  ${USE_SMART_LICENSE} == 0
     ...  Add AMP Feature Key
     Threatgrid Rekey Esa Sma
     Centralized Email Reporting Enable
     Listeners Add
     ...  listener_name=${Listeners_names}
     ...  type=${Listeners_type}
     ...  port=${Listeners_port}
     ...  interface=${Listeners_interface}
     ...  bounce_profile=${Listeners_bounce_profile}
     ...  submit=${True}
     RAT Recipient Add
     ...  ${Listeners_names}
     ...  address=${CLIENT}
     ...  action=${RAT_action}
     ${settings}=  Create Dictionary
     ...  Advanced Malware Protection  Yes
     ...  Enable File Analysis  ${True}
     ${settings_antispam}=  Create Dictionary
     ...  Anti-Spam Scanning  Disabled
     ${settings_antivirus}=  Create Dictionary
     ...  Anti-Virus Scanning  No
     Mail Policies Edit Antispam
     ...  Incoming
     ...  Default
     ...  ${settings_antispam}
     Mail Policies Edit Antivirus
     ...  Incoming
     ...  Default
     ...  ${settings_antivirus}
     Commit Changes
     Advancedmalware Enable
     Mail Policies Edit Advanced Malware Protection
     ...  Incoming
     ...  default
     ...  ${settings}
     Message Tracking Enable
     ...   tracking=centralized
     Commit Changes
     Restart CLI session
     Diagnostic Reporting Delete Db  confirm=yes
     Wait Until Ready
     Library Order SMA
     ${ESA_IP}=  Get Host IP By Name  ${ESA}
     Run Keyword And Ignore Error  Log Out Of Dut
     Log Into Dut

     Centralized Email Reporting Enable
     Centralized Email Message Tracking Enable
     Security Appliances Add Email Appliance
     ...  ${security_email_name}
     ...  ${ESA_IP}
     ...  reporting=${True}
     ...  ssh_credentials=${DUT_ADMIN}:${DUT_ADMIN_SSW_PASSWORD}
     Commit Changes
     Restart CLI session
     Diagnostic Reporting Delete Db  confirm=yes
     Wait Until Ready
     Restart CLI session
     Diagnostic Tracking Delete Db   confirm=yes
     Wait Until Ready

Generate File
     [Arguments]  ${source_file}  ${dest_file}  ${replace_string}
     ${random}=  Generate Random String
     log  ${random}
     Convert To String  ${random}
     Run  sed -e 's/${replace_string}/${random}/g' ${source_file} > ${dest_file}
     [Return]  ${dest_file}

Get File Sha256
     [Arguments]  ${file}
     ${file_sha256} =  Run  sha256sum ${file} | awk '{print $1}'
     [Return]  ${file_sha256}

Check User Account
     [Arguments]  ${user_name}  ${user_passwd}  ${verify}
     Launch DUT Browser
     Log Into DUT  user=${user_name}     password=${user_passwd}
     ${status}  ${msg}  Run Keyword And Ignore Error  Navigate To  Email  Reporting  Advanced Malware Protection
     Should Be Equal  ${status}  ${verify}
     ${status}  ${msg}  Run Keyword And Ignore Error  Navigate To  Email  Reporting  AMP File Analysis
     Should Be Equal  ${status}  ${verify}
     ${status}  ${msg}  Run Keyword And Ignore Error  Navigate To  Email  Reporting  AMP Verdict Updates
     Should Be Equal  ${status}  ${verify}
     Log Out Of Dut

Custom Test Case Setup
     Library Order ESA
     Setup Selenium Environment
     Configure Autodownload For Browser   ${TEMPDIR}   text/csv, application/pdf
     Run  rm -rf ${TEMPDIR}/*.part && rm -rf ${TEMPDIR}/*.csv
     Launch DUT Browser
     Log Into DUT
     DefaultTestCaseSetup

Add AMP Feature Key
     ${amp_file_rep_fkey}=  Generate DUT Feature Key  amp_file_rep
     ${amp_file_analysis_fkey}=  Generate DUT Feature Key  amp_file_analysis
     Start Cli Session If Not Open
     Feature Key Activate  ${amp_file_rep_fkey}
     Restart CLI Session
     Feature Key Activate  ${amp_file_analysis_fkey}
     Restart CLI Session


*** Test Cases ***
Tvh735121c
     [Documentation]   Verify 'AMP detected' counters in existing report pages Overview, Incoming mail
     ...  & Internal User reports are updated when emails sent to ESA are detected as AMP positive
     ...  link: http://tims.cisco.com/view-entity.cmd?ent=735121
     ...  1.Create a public listener & add RAT entries on ESA
     ...  2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...  3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...  4.Send emails with AMP positive & clean messages to ESA
     ...  5.Verify AMP detected Counter in Overview page is increased for AMP positive messages
     ...  6.Verify AMP detected counter in incoming mail report page is increased for AMP positive messages for that email sender
     ...  7.Verify AMP detected counter in Internal user report page is increased for AMP positive messages for that email recipient
     [Tags]  Standard  Tvh735121c  amp

     Set Test Variable  ${TEST_ID}  ${TEST NAME}

     Diagnostic Reporting Delete Db  confirm=yes
     Wait Until Ready

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}
     Sleep  10s

     Navigate To  Email  Reporting  Overview
     ${table_data}=   Wait Until Keyword Succeeds
     ...  30m
     ...  10s
     ...  Email Report Table Get Data
          ...  Incoming Mail Summary
     log  ${table_data}

     @{col_values} =  Get From Dictionary  ${table_data}
     ...  Messages
     ${value} =  Get From List  ${col_values}  5
     ${value} =  Convert To Integer  ${value}
    Should Be Equal As Integers  ${value}  1

     Navigate To  Email  Reporting  Incoming Mail
     ${table_incoming_mail}=  Email Report Table Get Data
     ...  Incoming Mail Details
     log  ${table_incoming_mail}
     @{col_values}=   Get From Dictionary  ${table_incoming_mail}
     ...  Detected by Advanced Malware Protection
     ${value_1} =  Get From List  ${col_values}  0
     ${value_1} =  Convert To Integer  ${value_1}
     Should Be Equal As Integers  ${value_1}  1

     Navigate To  Email  Reporting  Internal Users
     ${table_internal_users}=  Email Report Table Get Data
     ...   User Mail Flow Details
     log  ${table_internal_users}
     @{col_vlaues}=   Get From Dictionary  ${table_internal_users}
     ...   Incoming Detected by Advanced Malware Protection
     ${value_2} =  Get From List  ${col_values}  0
     ${value_2} =  Convert To Integer  ${value_2}
     Should Be Equal As Integers  ${value_2}  1

Tvh737274c
     [Documentation]   Verify users(internal & external) belonging to Administrator, Cloud
      ...    administrator, Operator, Read-Only operator & Guest user roles can access the
      ...    following newly added reporting pages - AMP report, File Analysis & AMP verdict
      ...    Updates reports
      ...    link: http://tims.cisco.com/view-entity.cmd?ent=735122
      ...    1.Create a public listener & add RAT entries on ESA
      ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
      ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
      ...    4.Add User beloging to Administrator, Cloud,administrator, Operator, Read-Only operator & Guest user
      ...    5.Check the AMP report,File Analysis & AMP verdict updates reports
     [Tags]   Standard   Tvh737274c   amp

     Set Test Variable  ${TEST_ID}  ${TEST NAME}

     @{user_account}  Create List  ${user_operator}  ${user_operator_fullname}  ${DUT_ADMIN_SSW_PASSWORD}  ${sma_user_roles.OPERATOR}
     ...  ${user_Read_only_operator}  ${user_read_only_operator_fullname}  ${DUT_ADMIN_SSW_PASSWORD}  ${sma_user_roles.RO_OPERATOR}
     ...  ${user_guest}  ${user_guest_fullname}  ${DUT_ADMIN_SSW_PASSWORD}  ${sma_user_roles.GUEST}

     FOR  ${user_id}  ${user_name}  ${user_password}  ${user_role}  IN  @{user_account}
       Users Add User
       ...  ${user_id}
       ...  ${user_name}
       ...  ${user_password}
       ...  user_role=${user_role}
     END

     Commit Changes

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}
     Log Out Of Dut

     @{page_check}  Create List  ${user_operator}  ${DUT_ADMIN_SSW_PASSWORD}  PASS
     ...  ${user_Read_only_operator}  ${DUT_ADMIN_SSW_PASSWORD}  PASS
     ...  ${user_guest}   ${DUT_ADMIN_SSW_PASSWORD}  PASS
     FOR  ${login_name}  ${login_pasword}  ${status}  IN  @{page_check}
       Check User Account
       ...  ${login_name}
       ...  ${login_pasword}
       ...  ${status}
     END

     Launch DUT Browser
     Log Into DUT

     @{Delete_account}  Create List  ${user_operator}  ${user_Read_only_operator}  ${user_guest}

     FOR  ${account}  IN  @{Delete_account}
       Users Delete User
       ...  ${account}
     END

     Commit Changes

Tvh737281c
     [Documentation]    Verify users(internal & external) belonging to Help desk & Technician
     ...    user roles cannot access the following newly added reporting pages - AMP report,
     ...    File Analysis & AMP verdict Updates reports
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=737281
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Add User beloging to Help desk & Technician
     ...    5.Check the AMP report,File Analysis & AMP verdict updates reports cant access
     [Tags]   Standard   Tvh737281c   amp

     Set Test Variable  ${TEST_ID}   ${TEST NAME}

     @{user_account}  Create List  ${user_help_desk}  ${user_help_desk_fullname}  ${DUT_ADMIN_SSW_PASSWORD}  Help Desk User
     ...  ${user_Technician_operator}  ${user_Technician_fullname}  ${DUT_ADMIN_SSW_PASSWORD}  Technician

     FOR  ${user_id}  ${user_name}  ${user_password}  ${user_role}  IN  @{user_account}
       Users Add User
       ...  ${user_id}
       ...  ${user_name}
       ...  ${user_password}
       ...  user_role=${user_role}
     END

     Commit Changes
     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}
     Log Out Of Dut

     @{page_check}  Create List  ${user_help_desk}  ${DUT_ADMIN_SSW_PASSWORD}  FAIL
     ...  ${user_Technician_operator}  ${DUT_ADMIN_SSW_PASSWORD}  FAIL

     FOR  ${login_name}  ${login_pasword}  ${status}  IN  @{page_check}
       Check User Account
       ...  ${login_name}
       ...  ${login_pasword}
       ...  ${status}
     END
     Log Into DUT

     @{Delete_account}  Create List  ${user_help_desk}  ${user_Technician_operator}

     FOR  ${account}  IN  @{Delete_account}
       Users Delete User
       ...  ${account}
     END

     Commit Changes

Tvh736806c
     [Documentation]    Verify from CLI & UI, loading a config file with scheduled reports for AMP,
     ...    retrospect & sandbox configured, is successful & shows these scheduled reports
     ...    configured in scheduled reports page
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=736806
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Add Scheduled Report
     ...    5.Reset Config
     ...    6.Load Config from config file
     ...    7.Check the Scheduled report
     [Tags]   Standard   Tvh736806c   amp

     Set Test Variable  ${TEST_ID}  ${TEST NAME}
     Log  ${sma_email_reports.ADVANCED_MALWARE_PROTECTION}
     Email Scheduled Reports Add Report  ${sma_email_reports.ADVANCED_MALWARE_PROTECTION}
     ...    report_format=pdf
     Commit Changes

     ${save_file}=   Configuration File Save Config   mask_passwd=${False}
     Configuration File Reset
     Selenium Close
     Start Cli Session If Not Open
     Configure SSL For GUI
     Selenium Login
     Configuration File Load Config   ${save_file}
     Commit Changes

     ${reports} =   Email Scheduled Reports Get Reports
     Log  ${reports}
     ${count}=  Get Length   ${reports}
     Should Be True   ${count}>=1

Tvh736805c
     [Documentation]    Verify from CLI & UI, save config works fine when the modules in the new reporting
     ...    pages are added to Dashboard
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=736805
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    5.Reset Config
     ...    6.Load Config from config file
     ...    7.Add the AMP report to Dashboard
     ...    8.Verify the Dashboard has AMP report
     [Tags]  Standard  Tvh736805c   amp

     Set Test Variable  ${TEST_ID}  ${TEST NAME}

     ${save_file}=   Configuration File Save Config   mask_passwd=${False}
     Configuration File Reset
     Selenium Close
     Start Cli Session If Not Open
     Configure SSL For GUI
     Selenium Login
     Configuration File Load Config   ${save_file}
     Commit Changes

     My Dashboard Reports Add
     ...   Time Range
     ...   Incoming Malicious Threat Files

     ${is_report_already_present}=  My Dashboard Report Exists
     ...   Time Range
     ...   Incoming Malicious Threat Files
     Log  ${is_report_already_present}
     ${boolean_value}=  Convert To Boolean   ${True}
     Should Be Equal  ${is_report_already_present}   ${boolean_value}

Tvh736804c
     [Documentation]    Verify from CLI & UI, save config works fine with scheduled reports for AMP,
     ...   retrospect & sandbox pages are configured
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=736804
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Add Scheduled Report
     ...    5.Reset Config
     ...    6.Load Config from config file
     ...    7.Check the Scheduled report
     [Tags]   Standard   Tvh736804c   amp

     Set Test Variable  ${TEST_ID}  ${TEST NAME}

     Email Scheduled Reports Add Report  ${sma_email_reports.ADVANCED_MALWARE_PROTECTION}
     ...    report_format=pdf
     Commit Changes

     ${save_file}=   Configuration File Save Config   mask_passwd=${False}
     Configuration File Reset
     Selenium Close
     Start Cli Session If Not Open
     Configure SSL For GUI
     Selenium Login
     Configuration File Load Config   ${save_file}
     Commit Changes

     ${reports} =   Email Scheduled Reports Get Reports
     Log  ${reports}
     ${count}=  Get Length   ${reports}
     Should Be True   ${count}>=1

Tvh735122c
     [Documentation]   Verify AMP report page is updated with SHA entry along with threat name & file
     ...    type when emails sent to ESA are detected as AMP positive
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=735122
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Send emails with AMP positive & clean messages to ESA
     ...    5.Verify SHA values which are identified as AMP positive are shown in AMP report page under Incoming Malware Threat files
     [Tags]   Standard   Tvh735122c   amp

     Set Test Variable  ${TEST_ID}   ${TEST NAME}
     [Setup]     DefaultTestCaseSetup

     Diagnostic Reporting Delete Db  confirm=yes
     Wait Until Ready

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}

     ${table_sha}=   Wait Until Keyword Succeeds
     ...  30m
     ...  10s
     ...  Reports Parse
          ...   page=Email, Reporting, Advanced Malware Protection
          ...   name=Incoming Malicious Threat Files
     log   ${table_sha}
     ${value_1} =  Get From List  ${table_sha}  0
     ${col_vlaues_1}=   Get From Dictionary  ${value_1}
     ...  Total Infected Files
     ${infected_length}=  Get Length  ${col_vlaues_1}
     ${value_2} =  Get From List  ${table_sha}  0
     ${col_vlaues_2}=   Get From Dictionary  ${value_2}
     ...  Malware Threat File SHA256
     ${sha_length}=  Get Length  ${col_vlaues_2}
     ${value_3} =  Get From List  ${table_sha}  0
     ${col_vlaues_3}=   Get From Dictionary  ${value_3}
     ...  File Type
     ${type_length}=  Get Length  ${col_vlaues_3}
     ${value_4} =  Get From List  ${table_sha}  0
     ${col_vlaues_4}=   Get From Dictionary  ${value_4}
     ...   Threat Name
     ${threat_length}=  Get Length  ${col_vlaues_4}
     ${value_5} =  Get From List  ${table_sha}  0
     ${col_vlaues_5}=   Get From Dictionary  ${value_5}
     ...   Filename
     ${file_length}=  Get Length  ${col_vlaues_5}

     Should Be True  ${sha_length}>=1
     Should Be True  ${file_length}>=1
     Should Be True  ${threat_length}>=1
     Should Be True  ${type_length}>=1
     Should Be True  ${infected_length}>=1

Tvh735120c
     [Documentation]    Verify searching by FileSHA & AMP positive messages in message tracking shows
     ...    tracking results matching this SHA value which was scanned by AMP and which was
     ...    detected as AMP positive
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=735120
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Send emails with AMP positive & clean messages to ESA
     ...    5.Search AMP Positive message in message tracking
     ...    6.Search Clean message in message tracking
     ...    7.Defect:CSCvj68973
     [Tags]   Standard   Tvh735120c   amp

     Set Test Variable  ${TEST_ID}  ${TEST NAME}
     [Setup]     DefaultTestCaseSetup

     Diagnostic Reporting Delete Db  confirm=yes
     Wait Until Ready
     Diagnostic Tracking Delete Db   confirm=yes
     Wait Until Ready

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}
     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX_1}  num-msgs=1
     ...  inject-host=${ESA_IP}

     Navigate To  Email  Reporting  Overview
     ${table_data}=   Wait Until Keyword Succeeds
     ...  30m
     ...  10s
     ...  Email Report Table Get Data
          ...  Incoming Mail Summary
     log  ${table_data}
     @{col_values} =  Get From Dictionary  ${table_data}
     ...  Messages
     ${value} =  Get From List  ${col_values}  5
     ${value} =  Convert To Integer  ${value}
     Should Be Equal As Integers  ${value}  1
     ${value} =  Get From List  ${col_values}  16
     ${value} =  Convert To Integer  ${value}
     Should Be Equal As Integers  ${value}  1

     ${messages}=   Email Message Tracking Search
     ...  attachment_file_sha256=${sha_value_malicious}
     ${tracking_message_count}=  Email Message Tracking Get Total Result Count  ${messages}
     Should Be True   ${tracking_message_count}>=1
     ${messages}=   Email Message Tracking Search
     ...  attachment_file_sha256=${sha_value_clean}
     ${tracking_message_count}=  Email Message Tracking Get Total Result Count  ${messages}
     Should Be True   ${tracking_message_count}>=1
     @{message_event_1}=  Create List  advanced malware protection
     ${messages}=   Email Message Tracking Search
     ...   attachment_file_sha256=${sha_value_malicious}
     ...   message_event=${message_event_1}
     ${tracking_message_count}=  Email Message Tracking Get Total Result Count  ${messages}
     Should Be True   ${tracking_message_count}>=1
     ${messages}=   Email Message Tracking Search
     ...   attachment_file_sha256=${sha_value_clean}
     ...   message_event=${message_event_1}
     ${tracking_message_count}=  Email Message Tracking Get Total Result Count  ${messages}
     Should Be True   ${tracking_message_count}>=1

Tvh737296c
     [Documentation]    Verify after reboot/shutdown & start, AMP related reporting data
     ...    is preserved by checking the reporting pages
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=737296
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
    ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Send emails with AMP positive to ESA
     ...    5.Reload the Devices
     ...    6.Check the AMP data is preserved after reboot
     [Tags]   Standard   Tvh737296c  amp
     Set Test Variable  ${TEST_ID}   ${TEST NAME}
     [Setup]     DefaultTestCaseSetup

     Diagnostic Reporting Delete Db  confirm=yes
     Wait Until Ready

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}
     Sleep  10s

     Navigate To  Email  Reporting  Overview
     ${table_data}=   Wait Until Keyword Succeeds
     ...  30m
     ...  10s
     ...  Email Report Table Get Data
          ...  Incoming Mail Summary
     Log  ${table_data}
     @{col_values} =  Get From Dictionary  ${table_data}
     ...  Messages
     ${value} =  Get From List  ${col_values}  5
     ${value} =  Convert To Integer  ${value}
     Should Be Equal As Integers  ${value}  1

     Reboot
     Sleep  30  Compensate default reboot delay
     Wait until DUT Reboots    wait_for_ports=443

     Launch DUT Browser
     Log Into DUT
     Sleep  10s
     Navigate To  Email  Reporting  Overview
     ${table_data}=   Wait Until Keyword Succeeds
     ...  30m
     ...  10s
     ...  Email Report Table Get Data
          ...  Incoming Mail Summary
     log  ${table_data}
     @{col_values} =  Get From Dictionary  ${table_data}
     ...  Messages
    ${value} =  Get From List  ${col_values}  5
    ${value} =  Convert To Integer  ${value}
    Should Be Equal As Integers  ${value}  1

Tvh737297c
     [Documentation]    Verify after reboot/shutdown & start, tracking by SHA256 & AMP
     ...    detected is successful & tracking details for the ESAs connected should be shown
     ...    as before reboot
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=737297
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Send emails with AMP positive to ESA
     ...    5.Reload the Devices
     ...    6.Search the AMP data via message tracking
     ...    7.Defect:CSCvj68973
     [Tags]    Standard   Tvh737297c   amp

     Set Test Variable  ${TEST_ID}   ${TEST NAME}
     [Setup]     DefaultTestCaseSetup

     Diagnostic Reporting Delete Db  confirm=yes
     Wait Until Ready
     Diagnostic Tracking Delete Db   confirm=yes
     Wait Until Ready

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}
     Navigate To  Email  Reporting  Overview
     ${table_data}=   Wait Until Keyword Succeeds
     ...  30m
     ...  10s
     ...  Email Report Table Get Data
          ...  Incoming Mail Summary
     log  ${table_data}
     @{col_values} =  Get From Dictionary  ${table_data}
     ...  Messages
     ${value} =  Get From List  ${col_values}  5
     ${value} =  Convert To Integer  ${value}
     Should Be Equal As Integers  ${value}  1
     ${messages}=   Email Message Tracking Search
     ...  attachment_file_sha256=${sha_value_malicious}
     ${tracking_message_count}=  Email Message Tracking Get Total Result Count  ${messages}
     Should Be True   ${tracking_message_count}>=1

     Reboot
     Sleep  30  Compensate default reboot delay
     Wait until DUT Reboots    timeout=900  wait_for_ports=443

     Launch DUT Browser
     Log Into DUT
     Sleep  10s
     Navigate To  Email  Reporting  Overview
     ${table_data}=   Wait Until Keyword Succeeds
     ...  30m
     ...  10s
     ...  Email Report Table Get Data
          ...  Incoming Mail Summary
     log  ${table_data}
     @{col_values} =  Get From Dictionary  ${table_data}
     ...  Messages
     ${value} =  Get From List  ${col_values}  5
     ${value} =  Convert To Integer  ${value}
     Should Be Equal As Integers  ${value}  1
     ${messages}=   Email Message Tracking Search
     ...  attachment_file_sha256=${sha_value_malicious}
     ${tracking_message_count}=  Email Message Tracking Get Total Result Count  ${messages}
     Should Be True   ${tracking_message_count}>=1

Tvh747779c
     [Documentation]  Verify "File analysis detail" for particular SHA256  has all details
     ...    specified in UX SPEC[General information[all values],Classification/Threat Score
     ...    ,Matching Signatures and Static file information present]
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=747779
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Send emails with AMP positive to ESA
     ...    5.click on the sha value of AMP messages
     ...    6.Check the File Reputation Summary,File Analysis Summary,General Information,Static File Info on AMP file analysis page
     [Tags]   Standard   Tvh747779c  Tvh747780c  amp

     Set Test Variable  ${TEST_ID}   ${TEST NAME}
     [Setup]     DefaultTestCaseSetup

     Diagnostic Reporting Delete DB  confirm=Yes
     Wait Until Ready

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  mbox-filename=${CLEAN_MBOX}  num-msgs=1
     ...  inject-host=${ESA_IP}
     Sleep  10s

     Reload Page
     Run keyword and ignore error  Login To DUT  ${DUT_ADMIN}  ${DUT_ADMIN_SSW_PASSWORD}
     ${res}=  Wait Until Keyword Succeeds
     ...  30m  30s
     ...  Reports Parse
          ...  page=Email, Reporting, Advanced Malware Protection
          ...  name=Incoming Malicious Threat Files
     Log List  ${res}
     ${var} =  Get From List  ${res}  0
     ${value} =  Get From Dictionary  ${var}  Malware Threat File SHA256
     Log  ${value}

     Reports Open Item
     ...  page=Email, Reporting, Advanced Malware Protection
     ...  name=Incoming Malicious Threat Files
     ...  item=${value}
     Page Should Contain  File Reputation Summary
     Page Should Contain  File Analysis Summary
     Page Should Contain  General Information
     Page Should Contain  Static File Info

Tvh747783c
     [Documentation]  Verify sheduled reports for  'File Analysis' Report is successfully scheduled
     ...    with different settings like time range, number of rows etc & reports are generated
     ...    at the scheduled time as per the settings
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=747783
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Add Scheduled report and verify the report
     [Tags]   Standard   Tvh747783c   amp

     Set Test Variable  ${TEST_ID}  ${TEST NAME}

     Reload Page
     Run keyword and ignore error  Login To DUT  ${DUT_ADMIN}  ${DUT_ADMIN_SSW_PASSWORD}
     Email Scheduled Reports Add Report  ${sma_email_reports.ADVANCED_MALWARE_PROTECTION_FILE_ANALYSIS}
     ...    report_format=pdf
     Commit Changes

     ${reports} =   Email Scheduled Reports Get Reports
     Log  ${reports}
     ${count}=  Get Length   ${reports}
     Should Be True   ${count}>=1
     Email Scheduled Reports Delete Report  ${sma_email_reports.ADVANCED_MALWARE_PROTECTION_FILE_ANALYSIS}

Tvh747768c
     [Documentation]   Verify the columns under "File analysis Request from this appliance"
     ...   table in "File analysis" Report[Four columns : File SHA256,Time analysis
     ...   Request,Time analysis Completed and Disposition should be present and have appropriate
     ...   values]
     ...    link: http://tims.cisco.com/view-entity.cmd?ent=747762
     ...    1.Create a public listener & add RAT entries on ESA
     ...    2.enable File reputation & analysis globally & in incoming mail policy on ESA
     ...    3.Enable Centralized reporting on SMA & ESA by adding ESA to SMA
     ...    4.Verify the Complete AMP file analysis report data
     [Tags]  Standard   Tvh747768c  Tvh747774c  Tvh747762c  Tvh747768c  Tvh747781c   amp

     Set Test Variable  ${TEST_ID}   ${TEST NAME}
     [Setup]   Custom Test Case Setup

     Library Order SMA
     Restart CLI Session
     Diagnostic Reporting Delete DB  confirm=Yes
     Wait Until Ready

     ${source}=  Set Variable  %{SARF_HOME}/tests/testdata/esa/advancedmalware/AMP-Async-upload8.exe
     ${dest}=  Set Variable  /tmp/AMP-Async-upload8.exe
     ${exe_file}=  Generate File  ${source}  ${dest}  stream

     ${file_sha256} =  Get File Sha256  ${dest}

     ${smtp_spam}=  Smtp Spam Start
     ...  rcpt-host-list=${CLIENT}
     ...  attach-filename=${exe_file}  num-msgs=1
     ...  inject-host=${ESA_IP}
     Sleep  10s

     Reload Page
     Run keyword and ignore error  Login To DUT  ${DUT_ADMIN}  ${DUT_ADMIN_SSW_PASSWORD}
     ${res}=  Wait Until Keyword Succeeds
     ...  30m  30s
     ...  Reports Parse
          ...  page=Email, Reporting, AMP File Analysis
          ...  name=Completed Analysis Requests
     Log List  ${res}
     ${var} =  Get From List  ${res}  0
     ${value} =  Get From Dictionary  ${var}
     ...  File SHA256
     ${sha_length}=  Get Length  ${value}
     ${value} =  Get From Dictionary  ${var}
     ...  Time of Analysis Request
     ${time_request_length}=  Get Length  ${value}
     ${value} =  Get From Dictionary  ${var}
     ...  Time Analysis Completed
     ${time_completed_length}=  Get Length  ${value}
     ${value} =  Get From Dictionary  ${var}
     ...  Disposition
     ${dispostion_length}=  Get Length  ${value}

     Should Be True  ${sha_length}>=1
     Should Be True  ${time_request_length}>=1
     Should Be True  ${time_completed_length}>=1
     Should Be True  ${dispostion_length}>=1


     Navigate To  Email  Reporting  AMP File Analysis
     Click Element  ${complete_table_export}  don't wait
     Sleep  25s
     Unselect Checkbox  ${analysis_request}
     Click Button  ${complete_button}   don't wait

     Click Element  ${complete_table_export}  don't wait
     Sleep  25s
     Select Checkbox  ${analysis_request}
     Click Button  ${complete_button}   don't wait
	
     Close All Browsers
     Selenium Login With Autodownload Enabled  %{SARF_HOME}/tmp  text/csv
     Log Out Of Dut
     Library Order ESA
     Selenium Login
     Navigate To  Monitor  AMP File Analysis
     Input Text  ${amp_search_sha}  ${file_sha256}
     Sleep  5s
     Click Element  ${search_button}

     Sleep  30s

     Page Should Contain  General Information
     Page Should Contain  Behavioral Indicators
     Page Should Contain  Static File Info

     Wait Until Page Contains Element  ${pending_table_export}  30s
     ${start_time}=   Get Time
     Click Element  ${pending_table_export}  don't wait

     ${status}  ${saved_config}  Run Keyword And Ignore Error   Wait For Download   .csv   start_time=${start_time}  download_directory=${TEMPDIR}  timeout=90
     OperatingSystem.File Should Exist   ${saved_config}

     ${csv_data} =  CSV Parser Get Data  ${saved_config}
     ${actual_file_sha256_compresed} =  Get From Dictionary  ${csv_data}  SHA256
     List Should Contain Value  ${actual_file_sha256_compresed}  ${file_sha256}

