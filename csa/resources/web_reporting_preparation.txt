# $Id: //prod/main/sarf_centos/resources/web_reporting_preparation.txt#1 $
# $DateTime: 2019/03/22 01:36:06 $
# $Author: aminath $

*** Settings ***
Library         SmaGuiLibrary      ${SMA}
Library         SmaCliLibrary     ${SMA}
Library         UtilsLibrary
Library         String
Library         OperatingSystem
Library         WsaCliLibrary     ${WSA}
Library         WsaGuiLibrary     ${WSA}
Variables       constants.py
Variables       sma/constants.py
Variables       credentials.py
Resource        selenium.txt

*** Keyword ***
Get IP Address
    [Arguments]   ${host_name}
    ${host_ip}=   Run      host ${host_name} | grep -E [\\.][^\\.\\ ]+[\\.]
    ${host_ip}=   Fetch From Right    ${host_ip}    ${SPACE}
    [Return]      ${host_ip}

Configure Test LDAP On WSA Appliance
    [Arguments]    ${WSA}   ${realm_name}
    Set Library Search Order        WsaGuiLibrary
    Set Suite Variable              ${DUT}   ${WSA}
    Selenium Login
    Run Keyword And Ignore Error    Authentication Delete Realm    ${realm_name}
    Authentication Add Ldap Realm   ${realm_name}
    ...           ${LDAP_AUTH_SERVER}
    ...           base_dn=${LDAP_BASE_DN}
    ...           uname_attr=${USER_NAME_ATTR}
    ...           run_test=${False}
    Commit Changes
    Selenium Close
    Set Library Search Order        SmaGuiLibrary

Configure AnyConnect On WSA Appliance
    [Arguments]    ${WSA}    ${REMOTE_CLIENT}
    ${REMOTE_CLIENT_HOST}=   Fetch From Left    ${REMOTE_CLIENT}    ${:}
    ${REMOTE_CLIENT_IP}=   Get IP Address     ${REMOTE_CLIENT_HOST}
    Set Library Search Order        WsaGuiLibrary
    Set Suite Variable              ${DUT}   ${WSA}
    Selenium Login
    ACSM Enable
    ...     user=ip
    ...     user_info=${REMOTE_CLIENT_IP}
    Commit Changes
    Selenium Close
    Set Library Search Order        SmaGuiLibrary

Configure Web Appliance For Web Reports
    [Arguments]   ${SMA}   ${WSA}  ${CM}=CM77
    [Documentation]    Enabling Centralized reporting on WSA
    Set Library Search Order        WsaGuiLibrary
    Set Suite Variable              ${DUT}   ${WSA}
    Selenium Login
    SSW Run                         testuser@mail.qa
    Wbrs And Anti Malware Edit Settings
    ...                             sophos=${False}
    Commit Changes
    Selenium Close
    Set Library Search Order        WsaCliLibrary
    Reporting Config Centralized    enable=yes
    Commit

    Configure Test LDAP On WSA Appliance    ${WSA}   TestLDAPRealm
    Set Library Search Order        SmaGuiLibrary
    Set Suite Variable              ${DUT}   ${SMA}
    Selenium Login
    System Setup Wizard Run        testuser@mail.qa
    Run Keyword And Ignore Error   Centralized Web Reporting Enable
    ${WSA_IP}=    Get IP Address   ${WSA}
    Run Keyword And Ignore Error   Security Appliances Delete Web Appliance   WSA1
    Run Keyword And Ignore Error   Centralized Web Configuration Manager Enable
    Run Keyword And Ignore Error   Configuration Masters Initialize    ${sma_config_masters.${CM}}   ${True}
    Security Appliances Add Web Appliance
    ...   WSA1
    ...   ${WSA_IP}
    ...   reporting=${True}
    ...   config_master=${sma_config_masters.${CM}}
    ...   ssh_credentials=admin:Cisco123$
    Commit Changes
    Run Keyword And Ignore Error   ${CM} Identities Delete Policy   Test
    Commit Changes
    Selenium Close
    Selenium Login
    Security Services Display Edit Cm Settings
    ...     ${sma_config_masters.${CM}}
    ...     https_proxy=${False}
    ...     upstream_proxy_groups=${False}
    ...     any_connect_secure_mobility=${False}
    ...     sophos_anti_malware=${False}
    ...     end_user_ack=${False}
    ...     external_dlp_servers=${False}
    ...     credential_encryption=${False}
    ...     identity_provider_for_saas=${False}
    Run Keyword  ${CM} Identities Add Policy
    ...     Test
    ...     auth_method=requires
    ...     auth_realm=TestLDAPRealm
    Commit Changes
    Selenium Close
    Selenium Login
    Run Keyword And Ignore Error   ${CM} Custom Url Categories Delete   Test
    Run Keyword  ${CM} Custom Url Categories Add
    ...     Test
    ...     sites=badsite.com
    Run Keyword  ${CM} Access Policies Edit Url Categories
    ...     Global Policy
    ...     Test:block
    Run Keyword  ${CM} Access Policies Edit Applications
    ...     Global Policy
    ...     actions=${applications.YOUTUBE}:block::
    Run Keyword  ${CM} Access Policies Edit Applications
    ...     Global Policy
    ...     actions=${applications.FACEBOOKGENERAL}:monitor:block_posting:
    Run Keyword  ${CM} Access Policies Edit Wbrs And Ams Settings
    ...     Global Policy
    ...     amw_categories=${mwcats.VIRUS}:block

	# enable SOCKS proxy for some destination ports
	Run Keyword If  "${CM}" == "CM77"  Run Keyword
	...  ${CM} SOCKS Policies Edit Destination Ports
	...   Global Policy
	...   tcp_ports=80, 8080
    ...   udp_ports=2000-3000
    ...   ports_settings=custom

    Commit Changes
    Publish To Web Appliances Configuration Master Now   myjob  ${sma_config_masters.${CM}}  WSA1
    Selenium Close
    Set Library Search Order        SmaGuiLibrary

Clear Web Reporting Data
    [Arguments]   ${SMA}   ${WSA}
    Set Library Search Order        WsaCliLibrary
    Set Suite Variable              ${DUT}   ${WSA}
    Diagnostic Reporting Delete Db  confirm=yes
	Wait Until Ready
    Set Library Search Order        SmaCliLibrary
    Set Suite Variable              ${DUT}    ${SMA}
    Diagnostic Reporting Delete Db  confirm=yes
    Roll Over Now   reportd_logs
    Roll Over Now   smad_logs
    Set Library Search Order        SmaGuiLibrary
	Wait Until Ready

Selenium Login With Autodownload Enabled
    Set Library Search Order        SmaGuiLibrary
    Set Suite Variable              ${DUT}   ${SMA}
    Setup Selenium Environment
    Configure Autodownload For Browser   %{HOME}   text/csv, application/pdf
    Launch DUT Browser
    Log Into DUT

Generate L4TM Test Data
    [Arguments]   ${WSA}
    Generate L4TM Data
    ...            wsa_dut=${WSA}
    ...            client=${LDAP_REPORTING_USER}
    ...            destination=l4tm_monitored.com
    ...            port=80
    ...            action=MONITORED
    ...            qty=1
    Generate L4TM Data
    ...            wsa_dut=${WSA}
    ...            client=${LDAP_REPORTING_USER}
    ...            destination=l4tm_blocked.com
    ...            port=80
    ...            action=BLOCKED
    ...            qty=1

Make Test Requests
    [Arguments]   ${WSA}
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://services.wga
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://ihaveabadreputation.com
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://services.wga/test-data/SSE/merlin/TrojanSpy.Win32.Banker3.exe
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://www.youtube.com
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://www.facebook.com/ajax/updatestatus.php?xhpc_message_text=test
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://badsite.com
    ...            qty=1

Make Test Requests From Remote Host
    [Arguments]   ${WSA}   ${REMOTE_CLIENT}
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://services.wga
    ...            qty=1
    ...            remote_client=${REMOTE_CLIENT}
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://ihaveabadreputation.com
    ...            qty=1
    ...            remote_client=${REMOTE_CLIENT}
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://services.wga/test-data/SSE/merlin/TrojanSpy.Win32.Banker3.exe
    ...            qty=1
    ...            remote_client=${REMOTE_CLIENT}
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://www.youtube.com
    ...            qty=1
    ...            remote_client=${REMOTE_CLIENT}
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://www.facebook.com/ajax/updatestatus.php?xhpc_message_text=test
    ...            qty=1
    ...            remote_client=${REMOTE_CLIENT}
    Make Requests
    ...            proxy=${WSA}:80
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://badsite.com
    ...            qty=1
    ...            remote_client=${REMOTE_CLIENT}

Make Test Requests via SOCKS
    [Arguments]   ${WSA}  ${port}
    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://services.wga
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://ihaveabadreputation.com
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://services.wga/test-data/SSE/merlin/TrojanSpy.Win32.Banker3.exe
    ...            qty=1

	# with hostnames

    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5-hostname
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://www.youtube.com
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5-hostname
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://www.facebook.com/ajax/updatestatus.php?xhpc_message_text=test
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5-hostname
    ...            url=http://badsite.com
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5-hostname
    ...            proxy_user=${LDAP_REPORTING_USER}:${LDAP_REPORTING_USER_PASSWORD}
    ...            url=http://services.wga:8080
    ...            qty=1
    Make Requests
    ...            proxy=${WSA}:${port}
	...            proxy_type=socks5-hostname
    ...            url=services.wga:60606
    ...            qty=1

