# $Id: //prod/main/sarf_centos/resources/sma/bat.txt#1 $ $DateTime: 2019/03/22 01:36:06 $ $Author: aminath $

*** Variables ***
${BUILD_SMA}     ${Empty}
${BUILD_SMA2}    ${Empty}
${BUILD_WSA}     ${Empty}
${BUILD_WSA2}    ${Empty}
${ALERT_RCPT}    testuser@mail.sma.sgg.cisco.com
${DEFAULT_CONFIG}  default_config.xml

*** Settings ***
Library     SmaGuiLibrary
Library     SmaCliLibrary
Library     SmaUtilsLibrary
Library     WsaGuiLibrary
Library     WsaCliLibrary
Library     WsaUtilsLibrary
Library     SmaGuiLibrary       ${SMA2}  with name  Sma2GuiLibrary
Library     SmaCliLibrary       ${SMA2}  with name  Sma2CliLibrary
Library     SmaUtilsLibrary     ${SMA2}  with name  Sma2UtilsLibrary
Library     WsaGuiLibrary       ${WSA2}  with name  Wsa2GuiLibrary
Library     WsaCliLibrary       ${WSA2}  with name  Wsa2CliLibrary
Library     WsaUtilsLibrary     ${WSA2}  with name  Wsa2UtilsLibrary
Variables   sma_intf.py    ${SMA}
Variables   sma_intf.py    ${SMA2}
Variables   wsa_intf.py    ${WSA}
Variables   wsa_intf.py    ${WSA2}
Resource    global.txt
#Resource    wsa/global.txt

*** Keywords ***
Library Order Sma
    ${out}  Set Library Search Order  SmaGuiLibrary  SmaCliLibrary  SmaUtilsLibrary

Library Order Wsa
    ${out}  Set Library Search Order  WsaGuiLibrary  WsaCliLibrary  WsaUtilsLibrary

Library Order Sma 2
    ${out}  Set Library Search Order  Sma2GuiLibrary  Sma2CliLibrary  Sma2UtilsLibrary

Library Order Wsa 2
    ${out}  Set Library Search Order  Wsa2GuiLibrary  Wsa2CliLibrary  Wsa2UtilsLibrary

#########################################
DefaultBatSuiteSetup
    Netinstall Appliances To Target Builds
    Library Order Sma
    DefaultSmaSuiteSetup  ${DNS}
    Library Order Sma 2
    DefaultSmaSuiteSetup  ${DNS}

    Library Order Wsa
    DefaultWsaSuiteSetup  ${DNS}
    Library Order Wsa 2
    DefaultWsaSuiteSetup  ${DNS}

DefaultBatSuiteTeardown
    Library Order Sma
    Wait Until Keyword Succeeds     2 min   5 sec
    ...  Start Cli Session
    Revert SMA To Initial State  ${DNS}
    Library Order Sma 2
    Wait Until Keyword Succeeds     2 min   5 sec
    ...  Start Cli Session
    Revert SMA To Initial State  ${DNS}

    Library Order Wsa
    Wait Until Keyword Succeeds     2 min   5 sec
    ...  Start Cli Session
    Revert WSA To Initial State  ${DNS}
    Library Order Wsa 2
    Wait Until Keyword Succeeds     2 min   5 sec
    ...  Start Cli Session
    Revert WSA To Initial State  ${DNS}

#########################################
DefaultBatTestCaseSetup
    Library Order Sma
    DefaultSmaTestCaseSetup
    Library Order Sma 2
    DefaultSmaTestCaseSetup

    Library Order Wsa
    DefaultWsaTestCaseSetup
    Library Order Wsa 2
    DefaultWsaTestCaseSetup

DefaultBatTestCaseTeardown
    Library Order Sma
    DefaultSmaTestCaseTeardown
    Library Order Sma 2
    DefaultSmaTestCaseTeardown

    Library Order Wsa
    DefaultWsaTestCaseTeardown
    Library Order Wsa 2
    DefaultWsaTestCaseTeardown

#######################################
DefaultBatTestCaseSetupSma
    Library Order Sma
    DefaultSmaTestCaseSetup

DefaultBatTestCaseTeardownSma
    Library Order Sma
    DefaultSmaTestCaseTeardown

#######################################
DefaultBatTestCaseSetupSmaWsa
    Library Order Sma
    DefaultSmaTestCaseSetup

    Library Order Wsa
    DefaultWsaTestCaseSetup

DefaultBatTestCaseTeardownSmaWsa
    Library Order Sma
    DefaultSmaTestCaseTeardown

    Library Order Wsa
    DefaultWsaTestCaseTeardown

######################################
DefaultBatTestCaseSetup2Sma
    Library Order Sma
    DefaultSmaTestCaseSetup
    Library Order Sma 2
    DefaultSmaTestCaseSetup

DefaultBatTestCaseTeardown2Sma
    Library Order Sma
    DefaultSmaTestCaseTeardown
    Library Order Sma 2
    DefaultSmaTestCaseTeardown

#####################################
DefaultBatTestCaseSetupSma2Wsa
    Library Order Sma
    DefaultSmaTestCaseSetup

    Library Order Wsa
    DefaultWsaTestCaseSetup
    Library Order Wsa 2
    DefaultWsaTestCaseSetup

DefaultBatTestCaseTeardownSma2Wsa
    Library Order Sma
    DefaultSmaTestCaseTeardown

    Library Order Wsa
    DefaultWsaTestCaseTeardown
    Library Order Wsa 2
    DefaultWsaTestCaseTeardown

######################################
DefaultBatTestCaseSetup2SmaWsa
    Library Order Sma
    DefaultSmaTestCaseSetup
    Library Order Sma 2
    DefaultSmaTestCaseSetup

    Library Order Wsa
    DefaultWsaTestCaseSetup

DefaultBatTestCaseTeardown2SmaWsa
    Library Order Sma
    DefaultSmaTestCaseTeardown
    Library Order Sma 2
    DefaultSmaTestCaseTeardown

    Library Order Wsa
    DefaultWsaTestCaseTeardown

#####################################
DefaultSmaSuiteSetup
    [Arguments]  ${dns}
    # Checking GUI access to DUT (a crash or a reboot could happen)
    ${ready}    ${out2}    Run Keyword And Ignore Error
    ...    Wait until DUT Is Accessible    wait_for_ports=${DUT_PORT}  timeout=360
    Run Keyword If   '${ready}' == 'FAIL'
    ...   Fatal Error    Gui became unavailable

    # Checking CLI access to DUT. If cli session was closed, trying to reopen it
    ${ready}    ${out2}    Run Keyword And Ignore Error
    ...    Start CLI Session If Not Open
    Run Keyword If   '${ready}' == 'FAIL'
    ...   Fatal Error    Cli session is not available and can not be reopened!

    Revert SMA To Initial State  ${dns}

    Run On DUT    rm /data/pub/configuration/${DEFAULT_CONFIG}
    ${name}=      Save Config
    Run On DUT    mv /data/pub/configuration/${name} /data/pub/configuration/${DEFAULT_CONFIG}

DefaultWsaSuiteSetup
    [Arguments]  ${dns}
    # Checking GUI access to DUT (a crash or a reboot could happen)
    ${ready}    ${out2}    Run Keyword And Ignore Error
    ...    Wait until DUT Is Accessible    wait_for_ports=8443  timeout=360
    Run Keyword If   '${ready}' == 'FAIL'
    ...   Fatal Error    Gui became unavailable

    # Checking CLI access to DUT. If cli session was closed, trying to reopen it
    ${ready}    ${out2}    Run Keyword And Ignore Error
    ...    Start CLI Session If Not Open
    Run Keyword If   '${ready}' == 'FAIL'
    ...   Fatal Error    Cli session is not available and can not be reopened!

    Revert WSA To Initial State  ${dns}

    Run On DUT    rm /data/pub/configuration/${DEFAULT_CONFIG}
    ${name}=      Save Config
    Run On DUT    mv /data/pub/configuration/${name} /data/pub/configuration/${DEFAULT_CONFIG}

    Library Order Sma

DefaultSmaTestCaseSetup
    DefaultTestCaseSetup

    #Checking CLI access to DUT. If cli session was closed, trying to reopen it
    ${ready}    ${out2}    Run Keyword And Ignore Error
    ...    Start CLI Session If Not Open
    Run Keyword If   '${ready}' == 'FAIL'
    ...   Fatal Error    Cli session is not available and can not be reopened!

    Selenium Login
    Load Config From File  ${DEFAULT_CONFIG}
    Commit
    Selenium Close

DefaultWsaTestCaseSetup
    DefaultTestCaseSetup

    #Checking CLI access to DUT. If cli session was closed, trying to reopen it
    ${ready}    ${out2}    Run Keyword And Ignore Error
    ...    Start CLI Session If Not Open
    Run Keyword If   '${ready}' == 'FAIL'
    ...   Fatal Error    Cli session is not available and can not be reopened!

    Selenium Login
    Configuration File Load  ${DEFAULT_CONFIG}
    Commit Changes
    Selenium Close
    Library Order Sma

DefaultSmaTestCaseTeardown
    DefaultTestCaseTeardown
    SSHLibrary.Close All Connections

DefaultWsaTestCaseTeardown
    DefaultTestCaseTeardown
    SSHLibrary.Close All Connections
    Library Order Sma

Revert SMA To Initial State
    [Documentation]    Reset configuration and run System Setup Wizard
    [Arguments]  ${dns}
    Suspend
    Wait Until Keyword Succeeds     2 min  1 min
    ...  Reset Config
    Selenium Login
    System Setup Wizard Run  ${ALERT_RCPT}  dns=${dns}
    Selenium Close

Revert WSA To Initial State
    [Documentation]    Reset configuration and run System Setup Wizard
    [Arguments]  ${dns}
    Wait Until Keyword Succeeds     2 min  1 min
    ...  Reset Config
    Selenium Login
    SSW Run  ${ALERT_RCPT}  dns=${dns}
    Selenium Close

Netinstall Appliances To Target Builds
    # Netinstall will have a place in case ${BUILD_SMA}, ${BUILD_SMA2},
    # ${BUILD_WSA} and ${BUILD_WSA2} are specified. Otherwise netinstall will
    # be skipped.
    # For exampls: --BUILD_SMA=zeus-8-0-0-080 --BUILD_WSA=coeus-7-5-1-006
    Library Order Sma
    Run Keyword If  '${BUILD_SMA}' != '${Empty}'  Netinstall  build_id_regex=${BUILD_SMA}  wait_for_ports=80
    Library Order Sma 2
    Run Keyword If  '${BUILD_SMA2}' != '${Empty}'  Netinstall  build_id_regex=${BUILD_SMA2}  wait_for_ports=80

    Library Order Wsa
    Run Keyword If  '${BUILD_WSA}' != '${Empty}'  Netinstall  build_id_regex=${BUILD_WSA}  wait_for_ports=8080
    Library Order Wsa 2
    Run Keyword If  '${BUILD_WSA2}' != '${Empty}'  Netinstall  build_id_regex=${BUILD_WSA2}  wait_for_ports=8080
