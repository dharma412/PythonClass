# $Id: //prod/main/sarf_centos/resources/sma/saml.txt#3 $
# $DateTime: 2019/12/02 00:51:58 $
# $Author: nthallap $

*** Settings ***
Resource     sma/global_sma.txt
Variables    sma/saml_constants.py
Library      OperatingSystem

*** Variables ***
${ASSERTION_CONSUMER_URL_DEVOPS}             http://${DUT}/devops_sso
${ASSERTION_CONSUMER_URL}                    http://${DUT}/acs

*** Keywords ***
Setup Firefox Preferences
    Close All Browsers
    Selenium Close
    ${firefox_prefs_browser.download.folderList}=  Set Variable  2
    ${firefox_prefs_browser.download.dir}=  Set Variable  %{SARF_HOME}/tmp/
    ${firefox_prefs_browser.helperApps.neverAsk.openFile}=  Set Variable  text/xml
    ${firefox_prefs_browser.helperApps.neverAsk.saveToDisk}=  Set Variable  text/xml
    Selenium Login

Delete SP IDP For Customer
    [Arguments]  ${sp_profile}  ${idp_profile}
    SAML Delete SP IDP  sp_name=${sp_profile}  idp_name=${idp_profile}
    Commit Changes

Delete SP For Customer
    [Arguments]   ${TEST_NAME}
    SAML DELETE SP IDP  sp_name=${TEST_NAME}
    Commit Changes

Delete IDP For Customer
    [Arguments]   ${TEST_IDP_PROFILE}
    SAML DELETE SP IDP  idp_name=${TEST_IDP_PROFILE}
    Commit Changes

SAML Add SP And IDP Profile For Customer
    [Arguments]  ${sp_profile}  ${idp_profile}
    ${settings}=  Create Dictionary
    ...  User Role                          ${USER_ROLE}
    ...  SP Entity ID                       ${SP_ENTITY_ID}
    ...  Assertion Consumer URL             ${ASSERTION_CONSUMER_URL}
    ...  SP Certificate                     ${CERT_FILE}
    ...  Private Key                        ${CERT_KEY}
    ...  Certificate Passphrase             ${CERTIFICATE_PASSPHRASE}
    ...  Sign Requests                      ${SIGN_REQUEST}
    ...  Organization Name                  ${ORGANIZATION_NAME}
    ...  Organization Display Name          ${ORGANIZATION_DISPLAY_NAME}
    ...  Organization URL                   ${ORGANIZATION_URL}
    ...  Organization Technical Contact     ${ORGANIZATION_TECHNICAL_CONTACT}
    ...  Configuration Mode                 ${CONFIGURATION_MODE}
    ...  Import IDP Metadata                ${IDP_METADATA}
    SAML Add SP And IDP  ${sp_profile}  ${idp_profile}  ${settings}
    Commit Changes

SAML Add SP IDP Config Manual For Customer
    ${settings}=  Create Dictionary
    ...  User Role                          ${USER_ROLE}
    ...  SP Entity ID                       ${SP_ENTITY_ID}
    ...  SP Certificate                     ${CERT_FILE}
    ...  Private Key                        ${CERT_KEY}
    ...  Certificate Passphrase             ${CERTIFICATE_PASSPHRASE}
    ...  Organization Name                  ${ORGANIZATION_NAME}
    ...  Organization Display Name          ${ORGANIZATION_DISPLAY_NAME}
    ...  Organization URL                   ${ORGANIZATION_URL}
    ...  Organization Technical Contact     ${ORGANIZATION_TECHNICAL_CONTACT}
    ...  Configuration Mode                 ${CONFIGURATION_MODE_MANUAL}
    ...  IDP Entity ID                      ${IDP_ENTITY_ID}
    ...  SSO URL                            ${SSO_URL}
    ...  Certificate                        ${CERT_FILE}
    SAML ADD SP AND IDP  ${TEST_SP_PROFILE}  ${TEST_IDP_PROFILE}  ${settings}
    Commit Changes


Download Metadata
    [Arguments]  ${sp_profile}=test_sp1_customer  ${user_role}=admin
    ${download_file}   Catenate  SEPARATOR=  ${sp_profile}  _metadata.xml
    Log   ${download_file}
    SAML Download SP Metadata        ${user_role}
    Wait Until Keyword Succeeds  1 minute  5s  OperatingSystem.File Should Exist  %{SARF_HOME}/tmp/${download_file}
    OperatingSystem.File Should Not Be Empty         %{SARF_HOME}/tmp/${download_file}
    ${sp_metadata}=  OperatingSystem.Get File  %{SARF_HOME}/tmp/${download_file}
    Log  ${sp_metadata}

SAML Add SP And IDP Profile For Devops
    [Arguments]  ${sp_profile}  ${idp_profile}
    ${settings}=  Create Dictionary
    ...  User Role                          ${USER_ROLE_DEVOPS}
    ...  SP Entity ID                       ${SP_ENTITY_ID}
    ...  Assertion Consumer URL             ${ASSERTION_CONSUMER_URL_DEVOPS}
    ...  SP Certificate                     ${CERT_FILE}
    ...  Private Key                        ${CERT_KEY}
    ...  Certificate Passphrase             ${CERTIFICATE_PASSPHRASE}
    ...  Sign Requests                      True
    ...  Organization Name                  ${ORGANIZATION_NAME}
    ...  Organization Display Name          ${ORGANIZATION_DISPLAY_NAME}
    ...  Organization URL                   ${ORGANIZATION_URL}
    ...  Organization Technical Contact     ${ORGANIZATION_TECHNICAL_CONTACT}
    ...  Configuration Mode                 ${CONFIGURATION_MODE_MANUAL}
    ...  IDP Entity ID                      ${IDP_ENTITY_ID}
    ...  SSO URL                            ${SSO_URL}
    ...  Certificate                        ${CERT_FILE}
    SAML ADD SP AND IDP  ${sp_profile}  ${idp_profile}  ${settings}
    Commit Changes

Delete SP IDP For Devops
    [Arguments]  ${sp_name}  ${idp_name}
    SAML Delete SP IDP  sp_name=${sp_name}  idp_name=${idp_name}  user_role=devops
    Commit Changes

Delete SP For Devops
    [Arguments]  ${sp_name}
    SAML Delete SP IDP  sp_name=${sp_name}   user_role=devops
    Commit Changes

Delete IDP For Devops
    [Arguments]  ${idp_name}
    SAML Delete SP IDP  idp_name=${idp_name}   user_role=devops
    Commit Changes

SAML Edit SP And IDP Profile For Devops
    [Arguments]  ${sp_profile}  ${idp_profile}  ${user_role}=${USER_ROLE}
    ${settings}=  Create Dictionary
    ...  User Role                          ${user_role}
    ...  SP Profile Name                    ${TEST_SP_PROFILE_EDIT}
    ...  SP Entity ID                       ${SP_ENTITY_ID}
    ...  Assertion Consumer URL             ${ASSERTION_CONSUMER_URL_DEVOPS}
    ...  SP Certificate                     ${CERT_FILE}
    ...  Private Key                        ${CERT_KEY}
    ...  Certificate Passphrase             ${CERTIFICATE_PASSPHRASE}
    ...  Sign Requests                      ${SIGN_REQUEST}
    ...  Organization Name                  ${ORGANIZATION_NAME}
    ...  Organization Display Name          ${ORGANIZATION_DISPLAY_NAME}
    ...  Organization URL                   ${ORGANIZATION_URL}
    ...  Organization Technical Contact     ${ORGANIZATION_TECHNICAL_CONTACT}
    ...  IDP Profile Name                   ${TEST_IDP_PROFILE_EDIT}
    ...  Configuration Mode                 ${CONFIGURATION_MODE}
    ...  Import IDP Metadata                ${IDP_METADATA}
    SAML EDIT SP AND IDP  ${sp_profile}  ${idp_profile}  ${settings}
    Commit Changes

Testcase Teardown
    [Arguments]  ${sp_profile}=test_sp1_devops
    ${download_file}   Catenate  SEPARATOR=  ${sp_profile}  _metadata.xml
    Log   ${download_file}
    OperatingSystem.Remove File                      %{SARF_HOME}/tmp/${download_file}
    OperatingSystem.File Should Not Exist            %{SARF_HOME}/tmp/${download_file}
    DefaultTestCaseTeardown

Verify Config Mode Manual Option
    [Arguments]  ${user_role}=${USER_ROLE}  ${assertion_url}=${ASSERTION_CONSUMER_URL}
    ${settings}=  Create Dictionary
    ...  User Role                          ${user_role}
    ...  SP Entity ID                       ${SP_ENTITY_ID}
    ...  Assertion Consumer URL             ${assertion_url}
    ...  SP Certificate                     ${CERT_FILE}
    ...  Private Key                        ${CERT_KEY}
    ...  Certificate Passphrase             ${CERTIFICATE_PASSPHRASE}
    ...  Sign Requests                      ${SIGN_REQUEST}
    ...  Organization Name                  ${ORGANIZATION_NAME}
    ...  Organization Display Name          ${ORGANIZATION_DISPLAY_NAME}
    ...  Organization URL                   ${ORGANIZATION_URL}
    ...  Organization Technical Contact     ${ORGANIZATION_TECHNICAL_CONTACT}
    ...  IDP Entity ID                      ${IDP_ENTITY_ID}
    ...  Configuration Mode                 ${CONFIGURATION_MODE_MANUAL}
    ...  SSO URL                            ${SSO_URL}
    ...  Certificate                        ${CERT_FILE}
    [Return]  ${settings}

Test Extentions Of Metadata Certificate Certificate Key
    [Arguments]  ${user_role}= ${USER_ROLE}  ${certificate_file}=${CERT_FILE}  ${certificate_passphrase}=${CERTIFICATE_PASSPHRASE}\n
    ...  ${certificate_key}=${CERT_KEY}  ${metadata}=${IDP_METADATA}
    ${settings}=  Create Dictionary
    ...  User Role                          ${user_role}
    ...  SP Entity ID                       ${SP_ENTITY_ID}
    ...  Assertion Consumer URL             ${ASSERTION_CONSUMER_URL_DEVOPS}
    ...  SP Certificate                     ${certificate_file}
    ...  Private Key                        ${certificate_key}
    ...  Certificate Passphrase             ${CERTIFICATE_PASSPHRASE}
    ...  Sign Requests                      ${SIGN_REQUEST}
    ...  Organization Name                  ${ORGANIZATION_NAME}
    ...  Organization Display Name          ${ORGANIZATION_DISPLAY_NAME}
    ...  Organization URL                   ${ORGANIZATION_URL}
    ...  Organization Technical Contact     ${ORGANIZATION_TECHNICAL_CONTACT}
    ...  Configuration Mode                 ${CONFIGURATION_MODE}
    ...  Import IDP Metadata                ${metadata}
    [Return]  ${settings}

Initialize Variables
    ${cert_file}=    OperatingSystem.Get File    ${CERT_FILE}
    Set Suite Variable  ${cert_file}
    ${cert_key}=    OperatingSystem.Get File    ${CERT_KEY}
    Set Suite Variable  ${cert_key}
    ${idp_metadata}=    OperatingSystem.Get File  ${IDP_METADATA}
    Set Suite Variable  ${idp_metadata}

Test Suite Setup
    DefaultTestSuiteSetup
    Initialize Variables

Add Customer SAML Config
    Saml Config New
    ...  sp_profile_name=${TEST_NAME}
    ...  sp_entity_id=${SP_ENTITY_ID}
    ...  sp_certificate=${cert_file}
    ...  sp_certificate_key=${cert_key}
    ...  sp_certificate_passphrase=${CERTIFICATE_PASSPHRASE}
    ...  sp_sign_request=Y
    ...  sp_sign_assertion_request=Y
    ...  sp_technical_contact_id=${ORGANIZATION_TECHNICAL_CONTACT}
    ...  sp_organization_url=${ORGANIZATION_URL}
    ...  sp_organization_name=${ORGANIZATION_NAME}
    ...  sp_organization_display_name=${ORGANIZATION_DISPLAY_NAME}
    ...  idp_profile_name=${TEST_NAME}
    ...  idp_metadata_action=${IDP_METADATA_ACTION_ENTER}
    ...  idp_entity_id=${IDP_ENTITY_ID}
    ...  idp_sso_url=${SSO_URL}
    ...  idp_certificate=${cert_file}
    Commit

Delete/Clear Customer SMAL Config
    Saml Config Delete
    Commit

Add Devops SAML Config
    Devops External Auth Config New
    ...  sp_profile_name=${TEST_NAME}
    ...  sp_entity_id=${SP_ENTITY_ID}
    ...  sp_certificate=${cert_file}
    ...  sp_certificate_key=${cert_key}
    ...  sp_certificate_passphrase=${CERTIFICATE_PASSPHRASE}
    ...  sp_sign_request=Y
    ...  sp_sign_assertion_request=Y
    ...  sp_technical_contact_id=${ORGANIZATION_TECHNICAL_CONTACT}
    ...  sp_organization_url=${ORGANIZATION_URL}
    ...  sp_organization_name=${ORGANIZATION_NAME}
    ...  sp_organization_display_name=${ORGANIZATION_DISPLAY_NAME}
    ...  idp_profile_name=${TEST_NAME}
    ...  idp_metadata_action=${IDP_METADATA_ACTION_ENTER}
    ...  idp_entity_id=${IDP_ENTITY_ID}
    ...  idp_sso_url=${SSO_URL}
    ...  idp_certificate=${cert_file}
    Commit

Delete/Clear Devops SMAL Config
    Devops External Auth Config Delete
    Commit

