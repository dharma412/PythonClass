#!/usr/bin/env python -tt
# $Id: //prod/main/sarf_centos/testlib/phoebe1200/gui/manager/mail_policies_def/advanced_malware_protection_entry_settings.py#4 $
# $DateTime: 2019/08/12 22:31:06 $
# $Author: saurgup5 $

from common.gui.decorators import set_speed
from common.gui.inputs_owner import get_object_inputs_pairs
from common.util.ordered_dict import OrderedDict
from base_policy_entry_settings import BasePolicyEntrySettings

ADVANCE_LINK = "//*[@id='arrow_closed']"
ADVANCED_LINK_MESSAGE_ERROR = "//*[@id='advanced_us_settings_me']/tr/th/span/a[2]"
ADVANCED_LINK_UNSCAN = "//*[@id='advanced_us_settings_su']/tr/th/span/a[2]"
ADVANCED_LINK_RATE_LIMIT = "//*[@id='advanced_us_settings_rl']/tr/th/span/a[2]"
ADVANCED_LINK_FILE_ANALYSIS = "//*[@id='form']/dl/dd/table/tbody[17]/tr/th/a/div[1]"
ADVANCED_LINK_MESSAGE_ERROR_TIP = "//*[@id='basic_us_settings_me']/tr/th/span/a[1]/img"
ADVANCED_LINK_RATE_LIMIT_TIP = "//*[@id='basic_us_settings_rl']/tr/th/span/a[1]/img"
ADVANCED_LINK_UNSCAN_TIP = "//*[@id='basic_us_settings_su']/tr/th/span/a[1]/img"


class AdvancedMalwareProtectionEntrySettings(BasePolicyEntrySettings):
    ENABLE_AMV_RADIOGROUP = ('Advanced Malware Protection',
                             {'Use Default Settings': "//input[@id='enable_amp_default']",
                              'Yes': "//input[@id='enable_amp_yes']",
                              'No': "//input[@id='enable_amp_no']"})
    ENABLE_FILEANALYSIS_CHECKBOX = ('Enable File Analysis',
                                    "//input[@id='enable_file_nalysis']")
    INCLUDE_X_HEADER_CHECKBOX = ('Include an X-header',
                                 "//input[@id='include_x_header']")
    CATEGORY_ITEMS_MAPPING = OrderedDict([
        ('Apply Action', ("//select[@id='{0}_action']", '_set_combos')),
        ('Archive Original', ({'No': "//input[@id='{0}_archive0' or @id='{0}_archive_no']",
                               'Yes': "//input[@id='{0}_archive1' or @id='{0}_archive_yes']"},
                              '_set_radio_groups')),
        ('Drop Malware', ({'No': "//input[@id='{0}_drop_infected_attachments_no']",
                           'Yes': "//input[@id='{0}_drop_infected_attachments_yes']"},
                          '_set_radio_groups')),
        ('Modify Subject', ({'No': "//input[@id='{0}_subj_no']",
                             'Prepend': "//input[@id='{0}_subj_pre' or @id='{0}_subj_prepend']",
                             'Append': "//input[@id='{0}_subj_app' or @id='{0}_subj_append']"},
                            '_set_radio_groups')),
        ('Add Subject Text', ("//input[@id='{0}_subj_txt' or @id='{0}_subj_text']",
                              '_set_edits')),
        ('Add Custom Header', ({'Yes': "//input[@id='{0}_hdr_yes']",
                                'No': "//input[@id='{0}_hdr_no']"},
                               '_set_radio_groups')),
        ('Add Custom Header Name', ("//input[@id='{0}__hdr_n' or @id='{0}_hdr_name']",
                                    '_set_edits')),
        ('Add Custom Header Value', ("//input[@id='{0}__hdr_t' or @id='{0}_hdr_text']",
                                     '_set_edits')),
        ('Modify Recipient', ({'Yes': "//input[@id='{0}_rbyes']",
                               'No': "//input[@id='{0}_rbno']"},
                              '_set_radio_groups')),
        ('Modified Recipient Address', ("//input[@id='{0}_rbaddr']",
                                        '_set_edits')),
        ('Send To Alternate Host', ({'Yes': "//input[@id='{0}_altyes']",
                                     'No': "//input[@id='{0}_altno']"},
                                    '_set_radio_groups')),
        ('Alternate Host', ("//input[@id='{0}_alttxt']",
                            '_set_edits'))])
    CATEGORIES_PREFIXES_MAPPING = {'file_analysis': 'Messages with File Analysis Pending',
                                   'unscan_msg_error': 'Unscannable Actions on Message Errors',
                                   'unscan_rate_limit': 'Unscannable Actions on Rate Limit',
                                   'unscan_service_unreachable': 'Unscannable Actions on AMP Service Not Available',
                                   'unsafe': 'Messages with Malware Attachments'}

    def _get_registered_inputs(self):
        return get_object_inputs_pairs(self) + \
               self._generate_common_settings_pairs(
                   self.CATEGORY_ITEMS_MAPPING,
                   self.CATEGORIES_PREFIXES_MAPPING)

    @set_speed(0.5, 'gui')
    def set(self, new_value):
        super(AdvancedMalwareProtectionEntrySettings, self).set(new_value)

        self._set_radio_groups(new_value,
                               self.ENABLE_AMV_RADIOGROUP)
        self._set_checkboxes(new_value,
                             self.ENABLE_FILEANALYSIS_CHECKBOX)
        self._set_checkboxes(new_value,
                             self.INCLUDE_X_HEADER_CHECKBOX)

        if self.gui._is_visible(ADVANCED_LINK_MESSAGE_ERROR_TIP):
            self.gui.click_element(ADVANCED_LINK_MESSAGE_ERROR, "don't wait")
        if self.gui._is_visible(ADVANCED_LINK_UNSCAN_TIP):
            self.gui.click_element(ADVANCED_LINK_UNSCAN, "don't wait")
        if self.gui._is_visible(ADVANCED_LINK_RATE_LIMIT_TIP):
            self.gui.click_element(ADVANCED_LINK_RATE_LIMIT, "don't wait")
        self.gui.click_element(ADVANCE_LINK, "don't wait")
        self.gui.click_element(ADVANCED_LINK_FILE_ANALYSIS, "don't wait")
        self._fill_categories_settings(new_value,
                                       self.CATEGORY_ITEMS_MAPPING,
                                       self.CATEGORIES_PREFIXES_MAPPING)
