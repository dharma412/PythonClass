#!/usr/bin/env python -tt
# $Id: //prod/main/sarf_centos/testlib/phoebe1100/gui/manager/mail_policies_def/advanced_malware_protection_entry_settings.py#1 $ $DateTime: 2019/03/22 01:36:06 $ $Author: aminath $

from common.gui.decorators import set_speed
from common.gui.inputs_owner import get_object_inputs_pairs
from common.util.ordered_dict import OrderedDict
from base_policy_entry_settings import BasePolicyEntrySettings

ADVANCED_LINK_UNSCAN_TEXT_TIP = "//*[@id='advanced_collapsed_amp_settings_unscan']/span"
ADVANCED_LINK_UNSAFE_TEXT_TIP = "//*[@id='advanced_collapsed_amp_settings_unsafe']/span"
ADVANCED_LINK_FILE_TEXT_TIP = "//*[@id='advanced_collapsed_amp_settings_file_analysis']/span"
ADVANCED_LINK_UNSCAN = "//*[@id='form']/dl/dd/table/tbody[3]/tr/th/a"
ADVANCED_LINK_UNSAFE = "//*[@id='form']/dl/dd/table/tbody[5]/tr/th/a"
ADVANCED_LINK_FILE_ANALYSIS = "//*[@id='form']/dl/dd/table/tbody[7]/tr/th/a"
ADVANCED_LINK = "//*[@id='arrow_closed']"


class AdvancedMalwareProtectionEntrySettings(BasePolicyEntrySettings):
    ENABLE_AMV_RADIOGROUP = ('Advanced Malware Protection',
                             {'Use Default Settings': "//input[@id='enable_amp_default']",
                              'Yes': "//input[@id='enable_amp_yes']",
                              'No': "//input[@id='enable_amp_no']"})
    ENABLE_FILEANALYSIS_CHECKBOX = ('Enable File Analysis',
                                    "//input[@id='enable_file_nalysis']")
    INCLUDE_X_HEADER_CHECKBOX = ('Include an X-header',
                                 "//input[@id='include_x_header']")
    CATEGORY_ITEMS_MAPPING = OrderedDict([
        ('Apply Action', ("//select[@id='{0}_action']", '_set_combos')),
        ('Archive Original', ({'No': "//input[@id='{0}_archive_no']",
                               'Yes': "//input[@id='{0}_archive_yes']"},
                              '_set_radio_groups')),
        ('Drop Malware', ({'No': "//input[@id='{0}_drop_infected_attachments_no']",
                           'Yes': "//input[@id='{0}_drop_infected_attachments_yes']"},
                          '_set_radio_groups')),
        ('Modify Subject', ({'No': "//input[@id='{0}_subj_no']",
                             'Prepend': "//input[@id='{0}_subj_prepend']",
                             'Append': "//input[@id='{0}_subj_append']"},
                            '_set_radio_groups')),
        ('Add Subject Text', ("//input[@id='{0}_subj_text']",
                              '_set_edits')),
        ('Add Custom Header', ({'Yes': "//input[@id='{0}_hdr_yes']",
                                'No': "//input[@id='{0}_hdr_no']"},
                               '_set_radio_groups')),
        ('Add Custom Header Name', ("//input[@id='{0}_hdr_name']",
                                    '_set_edits')),
        ('Add Custom Header Value', ("//input[@id='{0}_hdr_text']",
                                     '_set_edits'))])
    CATEGORIES_PREFIXES_MAPPING = {'file_analysis': 'Messages with File Analysis Pending',
                                   'unscan': 'Unscannable Attachments',
                                   'unsafe': 'Messages with Malware Attachments'}

    def _get_registered_inputs(self):
        return get_object_inputs_pairs(self) + \
               self._generate_common_settings_pairs(
                   self.CATEGORY_ITEMS_MAPPING,
                   self.CATEGORIES_PREFIXES_MAPPING)

    @set_speed(0, 'gui')
    def set(self, new_value):
        super(AdvancedMalwareProtectionEntrySettings, self).set(new_value)
        self._set_radio_groups(new_value,
                               self.ENABLE_AMV_RADIOGROUP)
        self._set_checkboxes(new_value,
                             self.ENABLE_FILEANALYSIS_CHECKBOX)
        self._set_checkboxes(new_value,
                             self.INCLUDE_X_HEADER_CHECKBOX)
        if self.gui._is_visible(ADVANCED_LINK_UNSCAN_TEXT_TIP):
            self.gui.click_element(ADVANCED_LINK_UNSCAN)
        if self.gui._is_visible(ADVANCED_LINK_UNSAFE_TEXT_TIP):
            self.gui.click_element(ADVANCED_LINK_UNSAFE)
        if self.gui._is_visible(ADVANCED_LINK_FILE_TEXT_TIP):
            self.gui.click_element(ADVANCED_LINK_FILE_ANALYSIS)
        self._fill_categories_settings(new_value,
                                       self.CATEGORY_ITEMS_MAPPING,
                                       self.CATEGORIES_PREFIXES_MAPPING)
